name: Build OTA Binary

on:
  push:
    paths:
      - "sketches/**"
      - ".github/workflows/ci.yml"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1â€‘ Checkout
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          persist-credentials: true

      # 2â€‘ Instalar Arduinoâ€‘CLI
      - name: Setup Arduinoâ€‘CLI
        uses: arduino/setup-arduino-cli@v1

      # 3â€‘ Instalar core ESP32
      - name: Install ESP32 core 2.0.14
        run: |
          arduino-cli core update-index
          arduino-cli core install esp32:esp32@2.0.14

      # 4â€‘ LibrerÃ­as necesarias
      - name: Install libraries
        run: |
          arduino-cli lib update-index
          arduino-cli lib install \
            "Adafruit SSD1306" \
            "Adafruit GFX Library" \
            "ArduinoJson"

      # 5â€‘ Copiar sketch
      - name: Prepare sketch folder
        run: |
          mkdir -p build/automatic
          cp sketches/automatic.ino build/automatic/automatic.ino

      # 6â€‘ Compilar y exportar binarios
      - name: Compile & export
        run: |
          arduino-cli compile \
            --fqbn esp32:esp32:esp32 \
            --export-binaries \
            build/automatic

      # 7â€‘ Publicar firmware Ãºnico + manifest
      - name: Publish firmware & manifest
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -e
          # 1. Extraer versiÃ³n
          RAW=$(grep -oP '#define\s+FW_VERSION\s+"[^"]+"' sketches/automatic.ino | head -n1)
          VER=$(echo "$RAW" | grep -oP '[0-9]+' || true)
          if [[ -z "$VER" ]]; then
            echo "âŒ FW_VERSION sin dÃ­gitos"; exit 1
          fi
          echo "VersiÃ³n: $VER"

          # 2. Ubicar binario
          BIN_SRC=$(find build/automatic -name "*.bin" | head -n1)
          if [[ -z "$BIN_SRC" ]]; then
            echo "âŒ No se encontrÃ³ .bin"; exit 1
          fi

          # 3. Copiar y versionar
          mkdir -p firmware
          FILE=firmware/firmware_${VER}.bin
          cp "$BIN_SRC" "$FILE"

          # 4. latest.json
          echo "{\"version\":\"$VER\",\"url\":\"https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/main/$FILE\"}" > firmware/latest.json

          # 5. Commit
          git config user.name  "github-actions[bot]"
          git config user.email "actions@github.com"
          git add "$FILE" firmware/latest.json
          git commit -m "ðŸ”¨ Build $VER"
          git push "https://x-access-token:${TOKEN}@github.com/${GITHUB_REPOSITORY}.git" HEAD:main
